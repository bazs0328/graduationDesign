---
description: 后端分层、API 与 DB 约定，与 TODO 模块对应
globs: backend/**/*.py
alwaysApply: false
---

# 后端约定

## 分层
- **路由**（routers/）：参数校验、调用 service、返回 Pydantic 模型；不写业务逻辑。
- **服务**（services/）：LLM/RAG/摘要/测验等业务；读 core 的 config、vectorstore、paths。
- **核心**（core/）：配置、LLM/Embedding、向量库、路径、ensure_user/ensure_kb。
- **数据**：models.py 表结构，schemas.py 请求/响应模型，db.py 与 ensure_schema 兼容旧库。

## API 与 TODO 对应
- 文档：`/api/kb`、`/api/docs`、`/api/docs/upload` → 需求①。
- 摘要/要点：`/api/summary`、`/api/keypoints` → 需求②；P0 待做「知识点摘要增强（讲解+来源）」。
- 问答：`/api/qa`、`/api/chat/sessions`、`/api/chat/sessions/{id}/messages` → 需求③；P0 待做「sources 持久化 + 多轮历史」。
- 测验：`/api/quiz/generate`、`/api/quiz/submit` → 需求④；P0 待做「模拟真题风格」。
- 进度：`/api/progress`、`/api/activity`、`/api/recommendations` → 需求⑤。

## 新增与修改
- 新路由：在 `main.py` 中 include_router；请求/响应型尽量放在 schemas.py。
- 新表/新字段：改 models.py，并在 db.py 的 ensure_schema 中做兼容（SQLite）。
- 环境变量：仅用 backend/.env，新增项同步到 .env.example。
